<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeRealé¢¨ãƒãƒƒãƒ— - ãƒ›ãƒ¼ãƒ </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        
        /* åœ°å›³ */
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
        #logout-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border: 1px solid #ccc; cursor: pointer; border-radius: 4px;
        }

        /* â˜…å¤‰æ›´1: å³ä¸‹ã®ä¸¸ã„æŠ•ç¨¿ãƒœã‚¿ãƒ³ (Floating Action Button) */
        #fab-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            background-color: #1DA1F2; /* ãƒ„ã‚¤ãƒƒã‚¿ãƒ¼ã£ã½ã„é’ */
            color: white; border-radius: 50%;
            font-size: 30px; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 2000; /* åœ°å›³ã‚ˆã‚Šæ‰‹å‰ã« */
            display: flex; justify-content: center; align-items: center;
        }
        #fab-btn:active { transform: scale(0.95); }

        /* â˜…å¤‰æ›´2: èƒŒæ™¯ã‚’æš—ãã™ã‚‹å¹• (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜ã®é»’ */
            z-index: 3000; display: none; /* æœ€åˆã¯éš ã™ */
        }

        /* â˜…å¤‰æ›´3: æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  (ç”»é¢ä¸­å¤®ã«æµ®ã‹ã¶) */
        #post-area {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 400px;
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 3001; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚ˆã‚Šæ‰‹å‰ã« */
            display: none; /* æœ€åˆã¯éš ã™ */
            text-align: center;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ å†…ã®è¦ç´  */
        #post-area input, #post-area button { margin: 8px 0; width: 100%; box-sizing: border-box; padding: 10px; }
        .close-btn { background-color: #ccc; color: black; margin-top: 5px; }
        .post-btn { background-color: #1DA1F2; color: white; font-weight: bold; }
        
    </style>
</head>
<body>

    <button id="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div id="map"></div>

    <button id="fab-btn" onclick="openModal()">ï¼‹</button>

    <div id="overlay" onclick="closeModal()"></div>

    <div id="post-area">
        <h3>æŠ•ç¨¿ã‚’ä½œæˆ</h3>
        <p id="welcome-msg" style="font-size:12px; color:gray;"></p>
        
        <input type="text" id="message" placeholder="ã„ã¾ä½•ã—ã¦ã‚‹ï¼Ÿ">
        <input type="file" id="fileInput">
        
        <div style="display:flex; gap:5px;">
            <input type="number" id="lat" placeholder="ç·¯åº¦" value="35.6895" step="0.0001">
            <input type="number" id="lng" placeholder="çµŒåº¦" value="139.6917" step="0.0001">
        </div>
        
        <button onclick="getLocation()" style="background-color: #f0f0f0; color: #333; border: 1px solid #ddd;">ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—</button>
        <button class="post-btn" onclick="doPost()">æŠ•ç¨¿ã™ã‚‹</button>
        <button class="close-btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <script>
        // â˜…â˜…â˜… ã‚ãªãŸã®API Gateway URL (/posts) ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const API_URL = "https://lur60pqr50.execute-api.us-east-1.amazonaws.com/dev/posts";

        const myUserId = localStorage.getItem("myUserID");
        if (!myUserId) window.location.href = "login.html";
        document.getElementById("welcome-msg").innerText = "ID: " + myUserId;

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ã®å‡¦ç† ---
        function openModal() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("post-area").style.display = "block";
        }
        function closeModal() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("post-area").style.display = "none";
        }
        // ------------------------

        // åœ°å›³å‡¦ç†
        const map = L.map('map').setView([35.6895, 139.6917], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        async function loadPosts() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                data.forEach(post => {
                    const lat = post.Latitude;
                    const lng = post.Longitude;
                    let dateStr = "æ—¥æ™‚ä¸æ˜";
                    if (post.Timestamp) {
                        const ts = parseInt(post.Timestamp); 
                        if (!isNaN(ts)) dateStr = new Date(ts * 1000).toLocaleString('ja-JP');
                    } else if (post.Date) {
                        dateStr = post.Date;
                    }

                    L.marker([lat, lng]).addTo(map)
                        .bindPopup(`
                            <b>${post.UserID}</b><br>
                            <small>${dateStr}</small><br>
                            ${post.Message}<br>
                            <img src="${post.ImageURL}" width="150">
                        `);
                });
            } catch(e) { console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e); }
        }
        loadPosts();

        // ç¾åœ¨åœ°å–å¾—
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('lat').value = position.coords.latitude;
                    document.getElementById('lng').value = position.coords.longitude;
                    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸï¼");
                }, () => { alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); });
            } else { alert("GPSéå¯¾å¿œã§ã™"); }
        }

        // æŠ•ç¨¿å‡¦ç†
        async function doPost() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const msg = document.getElementById('message').value;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;

            if (!file) { alert("ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
            if (!msg) { alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Image = reader.result;

                const postData = {
                    UserID: myUserId,
                    Message: msg,
                    Latitude: lat,
                    Longitude: lng,
                    Image: base64Image
                };

                try {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(postData)
                    });
                    
                    if (res.ok) {
                        alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
                        closeModal(); // â˜…æŠ•ç¨¿æˆåŠŸã—ãŸã‚‰é–‰ã˜ã‚‹
                        location.reload(); 
                    } else {
                        const err = await res.json();
                        alert("ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(err));
                    }
                } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); }
            };
        }

        function logout() {
            localStorage.removeItem("myUserID");
            window.location.href = "login_cognito.html";
        }
    </script>
</body>
</html>