<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Map Message App</title>
 <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
 <style>
   body { font-family: sans-serif; margin: 0; background-color: #f8f9fa; }

   /* ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   .auth-bar {
     background: #333;
     color: white;
     padding: 10px 20px;
     display: flex;
     justify-content: space-between;
     align-items: center;
     font-size: 14px;
   }
   .auth-bar button {
     background: #007bff;
     color: white;
     border: none;
     padding: 5px 15px;
     border-radius: 4px;
     cursor: pointer;
     font-weight: bold;
   }
   .auth-bar button:hover { background: #0056b3; }

   /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½™ç™½èª¿æ•´ */
   .main-content { padding: 20px; }

   #map { height: 500px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; z-index: 1; position: relative; }
 
   #post-list { border-top: 1px solid #ccc; padding-top: 10px; }
 
   /* 1ã¤1ã¤ã®æŠ•ç¨¿æ ã®èª¿æ•´ */
   .post-item {
       padding: 15px;
       display: flex;
       gap: 15px;
       background: white;
       margin-bottom: 12px;
       border-radius: 12px;
       box-shadow: 0 2px 6px rgba(0,0,0,0.05);
       transition: transform 0.1s;
   }
   .post-item:active {
       transform: scale(0.98);
       background-color: #f0f0f0;
   }
   .post-img {
       width: 80px;
       height: 80px;
       min-width: 80px;
       object-fit: cover;
       border-radius: 8px;
   }
   .post-content {
       flex: 1;
       display: flex;
       flex-direction: column;
       gap: 4px;
       word-break: break-all;
       line-height: 1.5;
       color: #333;
   }
   .post-content strong {
       color: #007bff;
       font-size: 15px;
   }
   .post-time { color: #888; font-size: 11px; }

   /* æŠ•ç¨¿ã‚’é–‹ãä¸¸ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   #toggleFormBtn {
       position: absolute;
       bottom: 25px;
       right: 25px;
       width: 56px;
       height: 56px;
       border-radius: 50%;
       background-color: #007bff;
       color: white;
       font-size: 30px;
       border: none;
       box-shadow: 0 4px 10px rgba(0,0,0,0.3);
       z-index: 1001;
       cursor: pointer;
       transition: transform 0.2s;
   }

   /* ãƒ•ã‚©ãƒ¼ãƒ ã‚’å¹ãå‡ºã—é¢¨ã«ã™ã‚‹ */
   #messageForm {
       position: absolute;
       bottom: 95px;
       right: 20px;
       background: white;
       padding: 15px;
       border-radius: 16px;
       box-shadow: 0 8px 30px rgba(0,0,0,0.2);
       z-index: 1001;
       width: 270px;
       display: flex;
       flex-direction: column;
       gap: 12px;
   }

   #msg {
       width: 100%;
       min-height: 100px;
       padding: 12px;
       border: 1px solid #ddd;
       border-radius: 8px;
       resize: none;
       font-family: inherit;
       font-size: 14px;
       line-height: 1.4;
       box-sizing: border-box;
   }

   #messageForm::after {
       content: "";
       position: absolute;
       bottom: -12px;
       right: 30px;
       border-width: 12px 12px 0;
       border-style: solid;
       border-color: white transparent transparent;
   }

   /* å…±é€šã®å…¥åŠ›ãƒ‘ãƒ¼ãƒ„è¨­å®š */
   #imageInput {
       width: 100%;
       padding: 10px;
       border: 1px solid #ddd;
       border-radius: 8px;
       box-sizing: border-box;
   }

   button#sendBtn {
       background: #007bff;
       color: white;
       border: none;
       padding: 12px;
       border-radius: 8px;
       font-weight: bold;
       cursor: pointer;
   }
   button:disabled { background: #ccc; cursor: not-allowed; }

   .leaflet-popup-content-wrapper {
       width: 280px;
       border-radius: 12px;
       padding: 5px;
       box-shadow: 0 4px 15px rgba(0,0,0,0.2);
   }

   .leaflet-popup-content {
       margin: 10px;
       width: auto !important;
       line-height: 1.5;
       font-size: 14px;
   }

   .popup-img {
       width: 100%;
       height: 150px;
       object-fit: cover;
       border-radius: 8px;
       margin-top: 8px;
       display: block;
   }

   .leaflet-popup-content strong {
       color: #007bff;
       font-size: 15px;
       display: block;
       margin-bottom: 4px;
   }

   .leaflet-control-custom a {
       background-color: #fff;
       border-bottom: 1px solid #ccc;
   }
   .leaflet-control-custom a:hover {
       background-color: #f4f4f4;
   }
 </style>
</head>
<body>

<div class="auth-bar">
  <span id="loginStatus">æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ï¼‰</span>
  <div>
    <button id="loginBtn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" onclick="logout()" style="display:none; background:#d9534f;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<div class="main-content">
  <h2>ãƒãƒƒãƒ—æ²ç¤ºæ¿</h2>
  <div id="status" style="margin-bottom:10px; font-size:12px; color:#666;">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>

  <div id="map">
   <button id="toggleFormBtn">+</button>

   <div id="messageForm" style="display: none;">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
       <span style="font-weight: bold; font-size: 16px;">æ–°è¦æŠ•ç¨¿</span>
       <button id="closeFormBtn" style="background:none; border:none; color:#999; cursor:pointer; font-size:18px;">Ã—</button>
     </div>
     <textarea id="msg" placeholder="ä»Šã©ã†ã—ã¦ã‚‹ï¼Ÿ"></textarea>
     <input type="file" id="imageInput" accept="image/*">
     <button id="sendBtn" disabled>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿</button>
   </div>
  </div>

  <h3>æœ€è¿‘ã®æŠ•ç¨¿</h3>
  <div id="post-list"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // 127.0.0.1 ã§é–‹ã„ã¦ã„ãŸã‚‰ localhost ã«å¯„ã›ã‚‹ï¼ˆCognito ã® localhost åˆ¶ç´„å›é¿ï¼‰
    // â€» search/hash ã‚’æ¨ã¦ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³æˆ»ã‚Šæƒ…å ±ãŒæ¶ˆãˆã‚‹ã®ã§å¿…ãšä¿æŒ
    if (location.hostname === "127.0.0.1") {
      const port = location.port ? `:${location.port}` : "";
      const to = `${location.protocol}//localhost${port}${location.pathname}${location.search}${location.hash}`;
      location.replace(to);
            // NOTE: ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ã¯ return ã§ããªã„ãŸã‚ã€ã“ã“ã§çµ‚äº†ã¯ã—ãªã„ã€‚
            // location.replace() ã«ã‚ˆã‚Šé·ç§»ã™ã‚‹ã®ã§ã€ä»¥é™ã®å‡¦ç†ã¯å®Ÿè³ªçš„ã«å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚
    }

   /* ===============================================================
      â†“â†“â†“ ã“ã“ã‚’ã‚ãªãŸã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â†“â†“
      =============================================================== */
   const API_URL = "https://57cs4olr6f.execute-api.us-east-1.amazonaws.com/dev/posts";

    const COGNITO_DOMAIN = "https://us-east-1svcwb7uid.auth.us-east-1.amazoncognito.com";
    const CLIENT_ID = "5q06ldkjlq283ghjpee3h5v6dt"; //MapApp20260104
     // å…¬é–‹URL/localhostä¸¡å¯¾å¿œï¼ˆã„ã¾é–‹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã¸æˆ»ã™ï¼‰
     const REDIRECT_URI = `${location.origin}${location.pathname}`;
   /* =============================================================== */

    let idToken = sessionStorage.getItem("idToken");
   let currentLat = 35.681236;
   let currentLng = 139.767125;
   const sendBtn = document.getElementById("sendBtn");
   const statusEl = document.getElementById("status");

     // åˆæœŸUIï¼ˆä½ç½®æƒ…å ±ã®æˆå¦ã«ä¾å­˜ã—ãªã„ï¼‰
     if (idToken) {
         sendBtn.disabled = false;
         sendBtn.innerText = "æŠ•ç¨¿ã™ã‚‹";
     } else {
         sendBtn.disabled = true;
         sendBtn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿";
     }

     // åœ°å›³åˆæœŸåŒ–ï¼ˆLeafletãŒèª­ã¿è¾¼ã‚ã¦ã„ãªã„å ´åˆã«è½ã¡ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰ï¼‰
     let map = null;
     if (!window.L) {
         if (statusEl) {
             statusEl.textContent = "åœ°å›³(Leaflet)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒ/åºƒå‘Šãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¢ºèªã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
         }
         console.error("Leaflet (window.L) is not available");
     } else {
         map = L.map("map").setView([currentLat, currentLng], 13);
         L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", { attribution: "Â© CARTO" }).addTo(map);
     }

   /* --- å¤‰æ•°ã®è¿½åŠ  --- */
   let allPosts = [];      // å–å¾—ã—ãŸå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—
   let currentPage = 1;    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·
   const postsPerPage = 5; // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°
   let markersMap = {};    // ãƒãƒ¼ã‚«ãƒ¼ç®¡ç†ç”¨

   /* ================= èªè¨¼é–¢é€£é–¢æ•° ================= */
   function login() {
     const url = `${COGNITO_DOMAIN}/login?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=openid+email+profile`;
     window.location.href = url;
   }

   function logout() {
         // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¿…ãšã‚¯ãƒªã‚¢ï¼ˆCognitoå´ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¦ã‚‚UIãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
         try { sessionStorage.removeItem("idToken"); } catch (_) {}
         idToken = null;

         // UIæ›´æ–°
         document.getElementById("loginBtn").style.display = "inline-block";
         document.getElementById("logoutBtn").style.display = "none";
         document.getElementById("loginStatus").innerText = "æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ï¼‰";
         sendBtn.disabled = true;
         sendBtn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿";
         document.getElementById("post-list").innerHTML = "<p style='text-align:center; padding:20px;'>æŠ•ç¨¿ã‚’è¦‹ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>";

         // åœ°å›³ä¸Šã®æŠ•ç¨¿ãƒ”ãƒ³ç­‰ã‚’ã‚¯ãƒªã‚¢
         allPosts = [];
         markersMap = {};
         if (map && window.L) {
             map.eachLayer((layer) => {
                 if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                     map.removeLayer(layer);
                 }
             });
             // ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ®‹ã™ï¼ˆtileLayerã¯Marker/CircleMarkerã§ã¯ãªã„ï¼‰
         }

         // Cognitoã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚åˆ‡ã‚‹ï¼ˆSign-out URL ã« REDIRECT_URI ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹å¿…è¦ã‚ã‚Šï¼‰
         const url = `${COGNITO_DOMAIN}/logout?client_id=${CLIENT_ID}&logout_uri=${encodeURIComponent(REDIRECT_URI)}`;
         window.location.href = url;
   }

   function handleAuthRedirect() {
     if (!location.hash) return;
     const params = new URLSearchParams(location.hash.substring(1));
     const token = params.get("id_token");
     if (token) {
       idToken = token;
             sessionStorage.setItem("idToken", idToken);
       
       // UIæ›´æ–°
       document.getElementById("loginBtn").style.display = "none";
       document.getElementById("logoutBtn").style.display = "inline-block";
       
       // ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰åå‰ã‚’å–å¾—
       const payload = parseJwt(idToken);
       const name = payload['cognito:username'] || payload['email'];
       document.getElementById("loginStatus").innerText = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${name}`;
       
       // æŠ•ç¨¿ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
       sendBtn.innerText = "æŠ•ç¨¿ã™ã‚‹";
       sendBtn.disabled = false;
       
       // URLã‚’ç¶ºéº—ã«ã™ã‚‹
       history.replaceState(null, "", location.pathname);
     }
   }

   // JWTãƒ‡ã‚³ãƒ¼ãƒ‰ç”¨é–¢æ•°
   function parseJwt(token) {
     var base64Url = token.split('.')[1];
     var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
     var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
       return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
     }).join(''));
     return JSON.parse(jsonPayload);
   }

   /* ================= ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ ================= */

   // 1. å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—
   // 1. å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—
   async function fetchAllPosts() {
       // â˜…è¿½åŠ : æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šã«è¡Œã‹ãªã„
       if (!idToken) {
           console.log("æœªãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚æŠ•ç¨¿ã‚’å–å¾—ã—ã¾ã›ã‚“");
           return;
       }

       // ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰è‡ªåˆ†ã®IDã‚’å–ã‚Šå‡ºã™ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–²è¦§åˆ¶é™åˆ¤å®šç”¨ï¼‰
       let myUserId = null;
       try {
           const payload = parseJwt(idToken);
           myUserId = payload.sub;
       } catch (e) {
           console.warn("Failed to parse idToken", e);
       }

       try {
           // â˜…å¤‰æ›´: userId ã‚’ã‚¯ã‚¨ãƒªã§æ¸¡ã™
           const url = myUserId ? `${API_URL}?userId=${encodeURIComponent(myUserId)}` : API_URL;

           const res = await fetch(url, {
               method: "GET", // æ˜ç¤ºçš„ã«æ›¸ã
               headers: {
                   // â˜…è¿½åŠ : ã“ã“ã§éµã‚’æ¸¡ã™
                   "Authorization": idToken
               }
           });

           // â˜…å¤‰æ›´: 403(æŠ•ç¨¿ãªã—/é–²è¦§åˆ¶é™)ã®å ´åˆã®å‡¦ç†
           if (res.status === 403) {
               document.getElementById("post-list").innerHTML = `
                   <div style="text-align:center; padding:30px; background:#fff3cd; border:1px solid #ffeeba; border-radius:8px;">
                       <h3 style="color:#856404;">ğŸ”’ é–²è¦§åˆ¶é™</h3>
                       <p>ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹ã«ã¯ã€24æ™‚é–“ä»¥å†…ã«1å›ä»¥ä¸ŠæŠ•ç¨¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
                       <p>ã¾ãšã¯ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                   </div>
               `;

               allPosts = [];
               markersMap = {};
               if (map && window.L) {
                   map.eachLayer((layer) => {
                       if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                           map.removeLayer(layer);
                       }
                   });
               }
               return;
           }

           if (res.status === 401) throw new Error("èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„");
           if (!res.ok) throw new Error("å–å¾—å¤±æ•—");
           
           const posts = await res.json();

           // â˜…è¿½åŠ : ã€Œè‡ªåˆ†ãŒ24æ™‚é–“ä»¥å†…ã«æŠ•ç¨¿ã—ã¦ã„ã‚‹ã‹ã€ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚åˆ¤å®š
           // ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¸¸ã«403ã‚’è¿”ã™ã¨ã¯é™ã‚‰ãªã„ãŸã‚ã€è¡¨ç¤ºå´ã§ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
           if (myUserId) {
               const nowSec = Math.floor(Date.now() / 1000);
               const limitSec = 24 * 60 * 60;
               const hasRecentPost = Array.isArray(posts) && posts.some((p) => {
                   const uid = p?.UserID ?? p?.userId ?? p?.userID;
                   const tsRaw = p?.Timestamp ?? p?.timestamp ?? p?.TS ?? null;
                   const ts = typeof tsRaw === "string" ? parseInt(tsRaw, 10) : (typeof tsRaw === "number" ? tsRaw : NaN);
                   return uid === myUserId && Number.isFinite(ts) && (nowSec - ts) <= limitSec;
               });

               if (!hasRecentPost) {
                   document.getElementById("post-list").innerHTML = `
                       <div style="text-align:center; padding:30px; background:#fff3cd; border:1px solid #ffeeba; border-radius:8px;">
                           <h3 style="color:#856404;">ğŸ”’ é–²è¦§åˆ¶é™</h3>
                           <p>ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹ã«ã¯ã€24æ™‚é–“ä»¥å†…ã«1å›ä»¥ä¸ŠæŠ•ç¨¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
                           <p>ã¾ãšã¯ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                       </div>
                   `;

                   allPosts = [];
                   markersMap = {};
                   if (map && window.L) {
                       map.eachLayer((layer) => {
                           if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                               map.removeLayer(layer);
                           }
                       });
                   }
                   return;
               }
           }

           allPosts = posts.sort((a, b) => parseInt(b.Timestamp) - parseInt(a.Timestamp));

           // â˜…å¤‰æ›´: ã„ã£ãŸã‚“åœ°å›³ä¸Šã®ãƒ”ãƒ³ã‚’å…¨å‰Šé™¤ã—ã¦å†æç”»ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
           markersMap = {};
           if (map && window.L) {
               map.eachLayer((layer) => {
                   if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                       map.removeLayer(layer);
                   }
               });

               // ç¾åœ¨åœ°ã®å††ã ã‘å†æç”»ï¼ˆåº§æ¨™ã¯å¸¸ã«ã‚ã‚‹ã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
               if (currentLat && currentLng) {
                   L.circleMarker([currentLat, currentLng], {
                       radius: 15,
                       fillColor: "#3388ff",
                       color: "#ffffff",
                       weight: 5,
                       opacity: 1,
                       fillOpacity: 0.7
                   }).addTo(map);
               }
           }

           allPosts.forEach(post => addMarkerToMap(post));
           displayPostList();
       } catch (err) {
           console.error(err);
           // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãªã©ã—ã¦ã‚‚è‰¯ã„
           document.getElementById("post-list").innerHTML = "<p>æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
       }
   }

   // 2. ä½ç½®æƒ…å ±ã®å–å¾—
   if (map && navigator.geolocation) {
       navigator.geolocation.getCurrentPosition(pos => {
           currentLat = pos.coords.latitude;
           currentLng = pos.coords.longitude;
           map.setView([currentLat, currentLng], 15);

           if (window.L) L.circleMarker([currentLat, currentLng], {
               radius: 15, fillColor: "#3388ff", color: "#ffffff",
               weight: 5, opacity: 1, fillOpacity: 0.7
           }).addTo(map);

           // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
           if (idToken) {
               sendBtn.disabled = false;
               sendBtn.innerText = "æŠ•ç¨¿ã™ã‚‹";
           } else {
               sendBtn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æŠ•ç¨¿";
           }
           statusEl.textContent = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼";
       }, () => {
           statusEl.textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚";
       });
   } else if (!navigator.geolocation) {
       if (statusEl) statusEl.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚";
   } else if (!map) {
       // map ãŒåˆæœŸåŒ–ã§ãã¦ã„ãªã„ï¼ˆLeafletæœªèª­è¾¼ãªã©ï¼‰
       // status ã¯ä¸Šã§å‡ºã—ã¦ã„ã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
   }

   // 3. ç”»åƒå‡¦ç†
   const processImage = (file) => new Promise((resolve) => {
       const reader = new FileReader();
       reader.readAsDataURL(file);
       reader.onload = (e) => {
       const img = new Image();
       img.src = e.target.result;
       img.onload = () => {
           const maxWidth = 600;
           const canvas = document.createElement('canvas');
           const scale = maxWidth / img.width;
           canvas.width = maxWidth;
           canvas.height = img.height * scale;
           const ctx = canvas.getContext('2d');
           ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
           resolve(canvas.toDataURL('image/jpeg', 0.7));
       };
       };
   });

   // 4. æŠ•ç¨¿å‡¦ç† (POST)
   sendBtn.addEventListener("click", async () => {
       // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
       if (!idToken) {
           alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
           login();
           return;
       }

       const msg = document.getElementById("msg").value;
       const file = document.getElementById("imageInput").files[0];

       if (!msg || !file) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

       sendBtn.disabled = true;
       sendBtn.textContent = "é€ä¿¡ä¸­...";

       try {
           // ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
           const payload = parseJwt(idToken);
           const uid = payload.sub; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
           const uName = payload['cognito:username'] || payload['email'] || "Unknown"; // ãƒ¦ãƒ¼ã‚¶ãƒ¼å

           const base64Img = await processImage(file);
           
           // Lambdaã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿
           const payloadData = {
               UserID: uid,
               UserName: uName, // â˜…è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é€ä¿¡
               Message: msg,
               Latitude: currentLat,
               Longitude: currentLng,
               Image: base64Img
           };

           const res = await fetch(API_URL, {
               method: "POST",
               headers: {
                   "Content-Type": "application/json",
                   "Authorization": idToken // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸
               },
               body: JSON.stringify(payloadData)
           });

           if (!res.ok) throw new Error(`HTTP Error ${res.status}`);

           // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æœ¬æ–‡ãŒã‚ã‚‹å ´åˆã«å‚™ãˆã¦æ¶ˆè²»ï¼ˆãªãã¦ã‚‚OKï¼‰
           try { await res.json(); } catch (_) {}

           alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼ãƒãƒƒãƒ—ã‚’æ›´æ–°ã—ã¾ã™ã€‚");

           // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
           messageForm.style.display = "none";
           toggleFormBtn.textContent = "+";
           document.getElementById("msg").value = "";
           document.getElementById("imageInput").value = "";

           // â˜…é‡è¦: æŠ•ç¨¿ç›´å¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼ˆä»–äººã®æŠ•ç¨¿å«ã‚€ï¼‰ã‚’å–ã‚Šç›´ã™
           await fetchAllPosts();

       } catch (err) {
           alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
       } finally {
           sendBtn.disabled = false;
           sendBtn.textContent = "æŠ•ç¨¿ã™ã‚‹";
       }
   });

   /* --- è¡¨ç¤ºé–¢é€£ --- */
   function displayPostList() {
       const list = document.getElementById("post-list");
       list.innerHTML = "";
       const startIndex = (currentPage - 1) * postsPerPage;
       const endIndex = startIndex + postsPerPage;
       const postsToShow = allPosts.slice(startIndex, endIndex);

       postsToShow.forEach(post => {
           const div = createPostItemElement(post);
           list.appendChild(div);
       });
       
       // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
       const pDiv = document.createElement("div");
       pDiv.style.textAlign = "center";
       pDiv.style.margin = "20px 0";
       
       const prev = document.createElement("button");
       prev.textContent = "â† æ–°ã—ã„æŠ•ç¨¿";
       prev.disabled = currentPage === 1;
       prev.onclick = () => { currentPage--; displayPostList(); window.scrollTo({top:500, behavior:'smooth'}); };
       
       const next = document.createElement("button");
       next.textContent = "å¤ã„æŠ•ç¨¿ â†’";
       next.disabled = endIndex >= allPosts.length;
       next.onclick = () => { currentPage++; displayPostList(); window.scrollTo({top:500, behavior:'smooth'}); };

       pDiv.appendChild(prev);
       pDiv.innerHTML += " ";
       pDiv.appendChild(next);
       list.appendChild(pDiv);
   }

   function createPostItemElement(post) {
       const div = document.createElement("div");
       div.className = "post-item";
       div.style.cursor = "pointer";
       const dateStr = post.Timestamp ? new Date(parseInt(post.Timestamp) * 1000).toLocaleString("ja-JP") : "ä¸æ˜";
       // åå‰ãŒã‚ã‚Œã°åå‰ã€ãªã‘ã‚Œã°IDã‚’è¡¨ç¤º
       const displayName = post.UserName || post.UserID || "åç„¡ã—";

       div.innerHTML = `
           <img src="${post.ImageURL}" class="post-img" onerror="this.src='https://via.placeholder.com/100?text=No+Image'">
           <div class="post-content">
           <div class="post-time">${dateStr}</div>
           <strong>${displayName}</strong>: ${post.Message}
           </div>
       `;
     
       div.onclick = () => {
           if (!map) return;
           map.setView([post.Latitude, post.Longitude], 16, { animate: true, duration: 1.0 });
           const markerKey = post.UserID + post.Timestamp;
           if (markersMap[markerKey]) markersMap[markerKey].openPopup();
           window.scrollTo({ top: 0, behavior: 'smooth' });
       };
       return div;
   }

   function addMarkerToMap(post) {
       if (!map || !window.L) return;
       const hueShift = getHueRotation(post.UserID);
       const dateStr = post.Timestamp ? new Date(parseInt(post.Timestamp) * 1000).toLocaleString("ja-JP") : "ä¸æ˜";
       const displayName = post.UserName || post.UserID || "åç„¡ã—"; // â˜…ãƒãƒƒãƒ—ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚‚åå‰å¯¾å¿œ

       const marker = L.marker([post.Latitude, post.Longitude]).addTo(map)
           .bindPopup(`
           <div class="popup-container">
               <div class="post-time" style="margin-bottom:2px;">${dateStr}</div>
               <strong>${displayName}</strong>
               <div style="margin-top:5px; word-break:break-all;">${post.Message}</div>
               <img src="${post.ImageURL}" class="popup-img" onerror="this.style.display='none'">
           </div>
           `);

       marker.on('add', function() {
           if (marker._icon) marker._icon.style.filter = `hue-rotate(${hueShift}deg)`;
       });

       const markerKey = post.UserID + post.Timestamp;
       markersMap[markerKey] = marker;
   }

   function getHueRotation(str) {
       if(!str) return 0;
       let hash = 0;
       for (let i = 0; i < str.length; i++) {
           hash = str.charCodeAt(i) + ((hash << 5) - hash);
       }
       return Math.abs(hash) % 360;
   }

   /* --- UIåˆ¶å¾¡ãã®ä»– --- */
   // ç¾åœ¨åœ°ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆåœ°å›³ãŒåˆæœŸåŒ–ã§ãã¦ã„ã‚‹ã¨ãã®ã¿ï¼‰
   if (map && window.L) {
     const HomeControl = L.Control.extend({
         options: { position: 'topleft' },
         onAdd: function (map) {
             const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
             container.innerHTML = `<a href="#" style="width:30px;height:30px;line-height:30px;display:block;text-align:center;background:white;"><svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:middle;"><path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M3.05,13H1V11H3.05C3.5,6.83 6.83,3.5 11,3.05V1H13V3.05C17.17,3.5 20.5,6.83 20.95,11H23V13H20.95C20.5,17.17 17.17,20.5 13,20.95V23H11V20.95C6.83,20.5 3.5,17.17 3.05,13Z" /></svg></a>`;
             container.onclick = (e) => {
                 e.preventDefault(); e.stopPropagation();
                 if (currentLat && currentLng) map.setView([currentLat, currentLng], 16, { animate: true });
                 else alert("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™...");
             };
             return container;
         }
     });
     map.addControl(new HomeControl());
   }

   const toggleFormBtn = document.getElementById("toggleFormBtn");
   const closeFormBtn = document.getElementById("closeFormBtn");
   const messageForm = document.getElementById("messageForm");

   toggleFormBtn.addEventListener("click", () => {
       if (messageForm.style.display === "none") {
           messageForm.style.display = "flex";
           toggleFormBtn.textContent = "Ã—";
       } else {
           messageForm.style.display = "none";
           toggleFormBtn.textContent = "+";
       }
   });

   closeFormBtn.addEventListener("click", () => {
       messageForm.style.display = "none";
       toggleFormBtn.textContent = "+";
   });

   /* åˆæœŸåŒ– */
   /* åˆæœŸåŒ– */
   window.onload = () => {
       // 1. ã¾ãšèªè¨¼æƒ…å ±ã‚’URLã‹ã‚‰ãƒã‚§ãƒƒã‚¯
       handleAuthRedirect();

             // 1.5 sessionStorage ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°UIã‚’å¾©å…ƒ
             if (idToken) {
                 try {
                     const payload = parseJwt(idToken);
                     const name = payload['cognito:username'] || payload['email'] || "(unknown)";
                     document.getElementById("loginBtn").style.display = "none";
                     document.getElementById("logoutBtn").style.display = "inline-block";
                     document.getElementById("loginStatus").innerText = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${name}`;
                     sendBtn.disabled = false;
                     sendBtn.innerText = "æŠ•ç¨¿ã™ã‚‹";
                 } catch (e) {
                     console.warn("Failed to parse stored idToken", e);
                 }
             }
       
       // 2. ã‚‚ã—ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼ˆidTokenãŒã‚ã‚‹ï¼‰ãªã‚‰ã€æŠ•ç¨¿ã‚’å–å¾—ã—ã«è¡Œã
       if (idToken) {
           fetchAllPosts();
       } else {
           // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®è¡¨ç¤º
           document.getElementById("post-list").innerHTML = "<p style='text-align:center; padding:20px;'>æŠ•ç¨¿ã‚’è¦‹ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>";
       }
   };
</script>
</body>
</html>
